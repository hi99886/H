<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Henzap Chat App</title>
<style>
  /* Basic WhatsApp-style dark mode vibe */
  body {
    margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #121212; color: #e1e1e1;
    display: flex; height: 100vh;
  }
  #sidebar {
    width: 280px; background: #1e1e1e; border-right: 1px solid #333;
    display: flex; flex-direction: column;
  }
  #contacts {
    flex-grow: 1; overflow-y: auto;
  }
  .contact {
    padding: 15px; border-bottom: 1px solid #333;
    cursor: pointer; display: flex; justify-content: space-between; align-items: center;
  }
  .contact:hover, .contact.active {
    background: #333;
  }
  #main {
    flex-grow: 1; display: flex; flex-direction: column;
  }
  #chat {
    flex-grow: 1; padding: 20px; overflow-y: auto; background: #222;
  }
  .message {
    margin-bottom: 12px;
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 18px;
    line-height: 1.3;
  }
  .msg-me {
    background: #0b93f6; color: white; margin-left: auto;
    border-bottom-right-radius: 4px;
  }
  .msg-them {
    background: #2c2c2c; color: #ddd;
    border-bottom-left-radius: 4px;
  }
  #input-bar {
    display: flex; padding: 10px; background: #1e1e1e;
  }
  #input-bar textarea {
    flex-grow: 1; resize: none; border-radius: 18px; border: none; padding: 10px 15px;
    font-size: 16px; background: #333; color: white;
  }
  #input-bar button {
    margin-left: 10px; background: #0b93f6; border: none; border-radius: 18px; color: white;
    font-weight: bold; padding: 0 20px; cursor: pointer;
  }
  #login-screen {
    position: fixed; inset: 0; background: #121212;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    z-index: 9999;
  }
  #login-screen input {
    margin: 8px 0; padding: 12px 15px; font-size: 16px; border-radius: 6px; border: none;
  }
  #login-screen button {
    background: #0b93f6; border: none; padding: 12px 20px; border-radius: 6px; color: white;
    font-weight: bold; cursor: pointer; margin-top: 10px; width: 100%;
  }
  #call-screen {
    position: fixed; inset: 0; background: rgba(0,0,0,0.9);
    display: none; flex-direction: column; justify-content: center; align-items: center;
    color: white; z-index: 10000;
  }
  #call-screen.active {
    display: flex;
  }
  #call-screen button {
    margin-top: 20px; background: #f44336; border: none; padding: 12px 24px;
    border-radius: 50%; font-size: 20px; cursor: pointer; color: white;
  }
</style>
</head>
<body>
  <div id="sidebar">
    <h2 style="text-align:center; padding:15px 0; margin:0; border-bottom:1px solid #333;">Henzap</h2>
    <div id="contacts"></div>
    <button id="add-contact-btn" style="margin:10px; padding:10px; background:#0b93f6; border:none; border-radius:8px; color:white; cursor:pointer;">+ Add Contact</button>
  </div>
  <div id="main">
    <div id="chat"></div>
    <div id="input-bar">
      <textarea id="message-input" rows="1" placeholder="Type a message..."></textarea>
      <button id="send-btn">Send</button>
      <button id="call-btn" title="Start Call">üìû</button>
      <button id="emoji-btn" title="Emoji Picker">üòä</button>
    </div>
  </div>

  <div id="login-screen">
    <h2 style="color:#0b93f6;">Welcome to Henzap</h2>
    <input type="email" id="login-email" placeholder="Email" />
    <input type="password" id="login-password" placeholder="Password" />
    <button id="sign-in-btn">Sign In</button>
    <button id="show-signup-btn" style="margin-top:15px; background:#1e88e5;">Sign Up (Pay ¬£5)</button>
    <button id="manager-login-btn" style="margin-top:15px; background:#ff9800;">Manager Login</button>
    <div id="payment-success" style="display:none; margin-top:20px; color:#4caf50;">
      Payment Successful! Now create your account.
      <button id="complete-signup-btn" style="margin-top:10px; background:#0b93f6;">Create Account</button>
    </div>
  </div>

  <div id="call-screen">
    <h2 id="call-status">Calling...</h2>
    <button id="hangup-btn">‚úñÔ∏è</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emoji-picker-element@^1/index.js" type="module"></script>

<script>
  const SUPABASE_URL = "https://vdxuqcsxfldxwifgxose.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkeHVxY3N4ZmxkeHdpZmd4b3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM1NDY5MzMsImV4cCI6MjA2OTEyMjkzM30.DbkqqAHZuyowGKo7gl5-EkpoYTXqAdspWKOJJTyciHU";

  const CLOUDINARY_CLOUD_NAME = "dy6bgkj72";
  const CLOUDINARY_UPLOAD_PRESET = "henzap_preset";

  const STRIPE_PUBLIC_KEY = "pk_test_51RpXJFJ1DrHNkTM3TEbigjZoM8pk7IyYVSitKfp2wzLGCthjCu2IKlZX5oF1jlF4uX7AZR35MKuoxk5zHH1DeRkG000vXe26jc";

  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Auth state
  let currentUser = null;
  let currentContact = null;

  // Manager password logic
  const MANAGER_PASSWORD = ":@";
  let managerUsed = false;

  // Fake payment simulation flag
  let paymentDone = false;

  // UI elements
  const loginScreen = document.getElementById("login-screen");
  const paymentSuccess = document.getElementById("payment-success");
  const emailInput = document.getElementById("login-email");
  const passInput = document.getElementById("login-password");
  const signInBtn = document.getElementById("sign-in-btn");
  const showSignupBtn = document.getElementById("show-signup-btn");
  const managerLoginBtn = document.getElementById("manager-login-btn");
  const completeSignupBtn = document.getElementById("complete-signup-btn");

  const contactsDiv = document.getElementById("contacts");
  const addContactBtn = document.getElementById("add-contact-btn");
  const chatDiv = document.getElementById("chat");
  const messageInput = document.getElementById("message-input");
  const sendBtn = document.getElementById("send-btn");
  const callBtn = document.getElementById("call-btn");
  const emojiBtn = document.getElementById("emoji-btn");
  const callScreen = document.getElementById("call-screen");
  const callStatus = document.getElementById("call-status");
  const hangupBtn = document.getElementById("hangup-btn");

  // Emoji picker
  let picker;
  emojiBtn.addEventListener('click', () => {
    if (!picker) {
      picker = document.createElement('emoji-picker');
      document.body.appendChild(picker);
      picker.style.position = 'fixed';
      picker.style.bottom = '60px';
      picker.style.right = '20px';
      picker.style.zIndex = 10000;
      picker.addEventListener('emoji-click', e => {
        messageInput.value += e.detail.unicode;
        messageInput.focus();
      });
    }
    picker.style.display = picker.style.display === 'none' ? 'block' : 'none';
  });

  // Show login screen or main app
  async function checkAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if(session?.user) {
      currentUser = session.user;
      loginScreen.style.display = "none";
      await loadContacts();
    } else {
      loginScreen.style.display = "flex";
    }
  }

  // Sign in
  signInBtn.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passInput.value;
    if(!email || !password) return alert("Enter email & password");
    const { error, data } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return alert(error.message);
    currentUser = data.user;
    loginScreen.style.display = "none";
    await loadContacts();
  };

  // Show fake payment screen (simulated)
  showSignupBtn.onclick = () => {
    alert("Fake payment of ¬£5 done. Click OK to continue signup.");
    paymentDone = true;
    paymentSuccess.style.display = "block";
  };

  // Complete signup after fake payment
  completeSignupBtn.onclick = async () => {
    if(!paymentDone) return alert("Complete payment first!");
    const email = emailInput.value.trim();
    const password = passInput.value;
    if(!email || !password) return alert("Enter email & password");
    const { error } = await supabase.auth.signUp({ email, password });
    if(error) return alert(error.message);
    alert("Account created! Please login now.");
    paymentSuccess.style.display = "none";
    paymentDone = false;
  };

  // Manager password login (single free account)
  managerLoginBtn.onclick = async () => {
    const password = passInput.value;
    if(password !== MANAGER_PASSWORD) return alert("Wrong manager password");
    if(managerUsed) return alert("Manager login already used");
    managerUsed = true;
    // Create or sign in with a single free account
    const email = "manager@henzap.local";
    const passwordFree = "managerpass123";
    let { data: userData } = await supabase.auth.admin.listUsers();
    // Not all supabase projects allow admin API in frontend, so just try signInWithPassword
    const { error, data } = await supabase.auth.signInWithPassword({ email, password: passwordFree });
    if(error) {
      // Try signup then sign in
      const { error: e2 } = await supabase.auth.signUp({ email, password: passwordFree });
      if(e2) return alert("Manager login error: " + e2.message);
      await supabase.auth.signInWithPassword({ email, password: passwordFree });
    }
    currentUser = supabase.auth.user();
    loginScreen.style.display = "none";
    await loadContacts();
  };

  // Load contacts (fake placeholder, load from supabase in real app)
  async function loadContacts() {
    contactsDiv.innerHTML = "";
    // For demo, add 1 GPT-4 contact
    addContact({ id: "gpt4", name: "GPT-4 AI", isBot: true });
  }

  // Add a contact to sidebar
  function addContact(contact) {
    const div = document.createElement("div");
    div.className = "contact";
    div.textContent = contact.name;
    div.onclick = () => openChat(contact);
    contactsDiv.appendChild(div);
  }

  // Open chat window for contact
  async function openChat(contact) {
    currentContact = contact;
    chatDiv.innerHTML = "";
    // Load chat messages from Supabase (fake here)
    // TODO: add real supabase query to load messages for this chat
  }

  // Send message (fake here)
  sendBtn.onclick = () => {
    const msg = messageInput.value.trim();
    if(!msg) return;
    addMessage(msg, true);
    messageInput.value = "";
    // TODO: send message to Supabase here
  };

  // Add message bubble
  function addMessage(text, isMe) {
    const div = document.createElement("div");
    div.className = "message " + (isMe ? "msg-me" : "msg-them");
    div.textContent = text;
    chatDiv.appendChild(div);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Fake call screen logic
  callBtn.onclick = () => {
    if(!currentContact) return alert("Select a contact to call");
    callStatus.textContent = `Calling ${currentContact.name}...`;
    callScreen.classList.add("active");
  };
  hangupBtn.onclick = () => {
    callScreen.classList.remove("active");
  };

  // Add new contact prompt
  addContactBtn.onclick = () => {
    const name = prompt("Enter contact name (word-style phone number):");
    if(!name) return;
    addContact({ id: name.toLowerCase().replace(/\s/g, ""), name });
  };

  checkAuth();
</script>
</body>
</html>
